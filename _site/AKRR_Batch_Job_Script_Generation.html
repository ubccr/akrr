<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="utf-8">
  <title>Application Kernel Remote Runner (AKRR) Details &rarr; Batch Job Script Generation</title>
  <link rel="icon" type="image/x-icon" href="/xdmod-jekyll-theme/assets/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/xdmod-jekyll-theme/assets/css/effervescence.css" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-44300156-3');
    ga('send', 'pageview');
  </script>
</head>
<body>
  <div id="page-container">
    <div id="page-header">
      <a href="http://open.xdmod.org"><img src="/xdmod-jekyll-theme/assets/images/xdmod_logo.png" alt="XDMoD" /></a>
      <span class="maintitle">Application Kernel Remote Runner (AKRR) Module 2.1.1</span>
    </div>
    
    <div id="page-body">
      <div class="clear"></div>
      <div id="page-menu">
          <div class="page-menu-toc">
        
            
                <h2>About</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/">Overview</a></li>
                            
                    
                    </ul>
                
            
                <h2>Download</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Download.html">Download</a></li>
                            
                    
                    </ul>
                
            
                <h2>Install</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Install.html">Install</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Update.html">Update</a></li>
                            
                    
                    </ul>
                
            
                <h2>Using</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Usage.html">Using</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Add_Resource.html">Adding New Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Deployment_of_Application_Kernel_on_Resource.html">Adding Appkernel to Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NAMD_Deployment.html">Adding NAMD</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCC_Deployment.html">Adding HPCC</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCG_Deployment.html">Adding HPCG</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IMB_Deployment.html">Adding IMB</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IOR_Deployment.html">Adding IOR</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_MDTest_Deployment.html">Adding MDTest</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NWChem_Deployment.html">Adding NWChem</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_GAMESS_Deployment.html">Adding GAMESS</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_ENZO_Deployment.html">Adding ENZO</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Tasks_Scheduling.html">Scheduling Appkernels</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Walltimelimit_Setting.html">Setting AK Walltime</a></li>
                            
                    
                    </ul>
                
            
                <h2>Details</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_HowItWorks.html">How It Works</a></li>
                            
                    
                            
                            <li class="active"><a href="/AKRR_Batch_Job_Script_Generation.html">Batch Job Script Generation</a></li>
                            
                    
                    </ul>
                
            
                <h2>Next</h2>
                
                    <ul>
                    
                            
                            <li ><a href="https://appkernels.xdmod.org/">xdmod-appkernels</a></li>
                            
                    
                    </ul>
                
            
        
    </div>
          
        
      </div>
      <div id="page-content">
         <h1>Details &rarr; Batch Job Script Generation</h1> 
        <h1 id="batch-job-script-generation-from-nested-templates">Batch Job Script Generation from Nested Templates</h1>

<p>AKRR is designed with a need to execute multiple application kernels on multiple HPC resources. 
The complexity of this task in part comes from
the fact that various HPC resources can be severely different in hardware and software. 
For example, HPC resources can use different queueing
systems, different vendors and versions of MPI, BLAS and others libraries. 
Furthermore, some applications can be compiled in number of way
which will affect how they should be executed (e.g. TCP/IP vs MPI). 
This makes impossible to create a single job script which will work on all
platforms. 
A large set of separate job scripts for every application kernel on every HPC resource would be unbearable to maintain. 
AKRR
addresses variability of batch job scripts by the use of templates.</p>

<p>Job script is created from template for every new task.
The root template (variable <code class="language-plaintext highlighter-rouge">batch_job_template</code>) for batch job script is located at
<code class="language-plaintext highlighter-rouge">$AKRR_SRC/akrr/default_conf/default.resource.conf</code> and listed bellow:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="c1"># master batch job script template
</span><span class="n">batch_job_template</span> <span class="o">=</span> <span class="s">"""{batch_job_header_template}

{akrr_common_commands_template}

{akrr_run_appkernel}

{akrr_common_cleanup_template}
"""</span>

<span class="p">...</span>

<span class="n">akrr_run_appkernel</span> <span class="o">=</span> <span class="s">"""{run_script_pre_run}

{appkernel_run_env_template}

{akrr_gen_appker_sign}

{akrr_run_appkernel_template}

{run_script_post_runCustom}

{run_script_post_run}
"""</span>
<span class="p">...</span>
</code></pre></div></div>

<p>The variables in figure brackets will be replaced by their values during the batch job script creation.
For example content of variable <code class="language-plaintext highlighter-rouge">akrr_run_appkernel</code> will replace <code class="language-plaintext highlighter-rouge">{akrr_run_appkernel}</code> in <code class="language-plaintext highlighter-rouge">batch_job_template</code>.
The replacement is performed recursively until all template variables replaced, 
that is template variable can contain other template variables. 
Double figure brackets will be eventually substituted with a single figure bracket.</p>

<p>During the batch job script creation the variables are read from following configurations and in shown order
(new records replaced old one, allowing to overwrite default values):</p>

<ul>
  <li>Resource configuration (read from file-system):
    <ul>
      <li><code class="language-plaintext highlighter-rouge">$AKRR_SRC/akrr/default_conf/default.resource.conf</code> <em>(should not be modified)</em></li>
      <li><code class="language-plaintext highlighter-rouge">$AKRR_HOME/etc/resources/&lt;resource_name&gt;/resource.conf</code> <em>(resource specific config)</em></li>
    </ul>
  </li>
  <li>Application kernel configuration (read from file-system):
    <ul>
      <li><code class="language-plaintext highlighter-rouge">$AKRR_SRC/akrr/default_conf/default.app.conf</code> <em>(should not be modified)</em></li>
      <li><code class="language-plaintext highlighter-rouge">$AKRR_SRC/akrr/default_conf/&lt;appkernel_name&gt;.app.conf</code> <em>(should not be modified)</em></li>
      <li><code class="language-plaintext highlighter-rouge">$AKRR_HOME/etc/resources/&lt;resource_name&gt;/&lt;appkernel_name&gt;.conf</code> <em>(appkernel on the resource specific config)</em></li>
    </ul>
  </li>
  <li>Task parameters (read from database for each task):
    <ul>
      <li>That is there number of nodes to use is specified.</li>
    </ul>
  </li>
</ul>

<p>The first variable in <code class="language-plaintext highlighter-rouge">batch_job_template</code> is <code class="language-plaintext highlighter-rouge">{batch_job_header_template}</code>, 
which describes the resources request and other stuff which usually present in the
beginning of all job scripts for a given HPC resource.
<code class="language-plaintext highlighter-rouge">batch_job_template</code> should be defined in resource configuration file for each resource, for example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fragment of $AKRR_HOME/etc/resources/&lt;resource_name&gt;/resource.conf`
</span><span class="p">...</span>

<span class="n">batch_job_header_template</span><span class="o">=</span><span class="s">"""#!/bin/bash
#SBATCH --partition=general-compute
#SBATCH --qos=general-compute
#SBATCH --nodes={akrr_num_of_nodes}
#SBATCH --ntasks-per-node={akrr_ppn}
#SBATCH --time={akrr_walltime_limit}
#SBATCH --output={akrr_task_work_dir}/stdout
#SBATCH --error={akrr_task_work_dir}/stderr
#SBATCH --constraint=OPA,CPU-Gold-6130
#SBATCH --exclusive
"""</span>

<span class="p">...</span>
</code></pre></div></div>

<p>This header template will be used for generation of all batch job scripts on that resource.
This way if there is a need to update the header (for example set a new charging account) this can be done in one place.</p>

<p>The template variable <code class="language-plaintext highlighter-rouge">{akrr_run_appkernel}</code> build from multiple templates which is modified either in 
global default app configuration, particular app default configuration or/and resource specific app configuration depanding 
on particular application kernels execution pattern. Most often only <code class="language-plaintext highlighter-rouge">{appkernel_run_env_template}</code> need to be
modified for an appkernel config for specific resource.</p>

<p>See <a href="/AKRR_Add_Resource.html">Adding HPC Resource</a> for details on resource configuration and 
<a href="/AKRR_Deployment_of_Application_Kernel_on_Resource.html">Deployment of Application Kernels on Resource</a> 
as starting point for individual appkernels configurations.</p>


      </div>
      <div class="clear"></div>
    </div>
    <div id="page-footer">
      <a href="https://www.buffalo.edu/ccr" target="_blank"><img src="/xdmod-jekyll-theme/assets/images/ccr_logo.png" alt="Center for Computational Research"/></a>
    </div>
  </div>
</body>
</html>
