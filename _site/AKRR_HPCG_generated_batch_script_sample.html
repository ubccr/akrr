<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="utf-8">
  <title>Application Kernel Remote Runner (AKRR) </title>
  <link rel="icon" type="image/x-icon" href="/xdmod-jekyll-theme/assets/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/xdmod-jekyll-theme/assets/css/effervescence.css" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-44300156-3');
    ga('send', 'pageview');
  </script>
</head>
<body>
  <div id="page-container">
    <div id="page-header">
      <a href="http://open.xdmod.org"><img src="/xdmod-jekyll-theme/assets/images/xdmod_logo.png" alt="XDMoD" /></a>
      <span class="maintitle">Application Kernel Remote Runner (AKRR) Module 2.1.1</span>
    </div>
    
    <div id="page-body">
      <div class="clear"></div>
      <div id="page-menu">
          <div class="page-menu-toc">
        
            
                <h2>About</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/">Overview</a></li>
                            
                    
                    </ul>
                
            
                <h2>Download</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Download.html">Download</a></li>
                            
                    
                    </ul>
                
            
                <h2>Install</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Install.html">Install</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Update.html">Update</a></li>
                            
                    
                    </ul>
                
            
                <h2>Using</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Usage.html">Using</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Add_Resource.html">Adding New Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Deployment_of_Application_Kernel_on_Resource.html">Adding Appkernel to Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NAMD_Deployment.html">Adding NAMD</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCC_Deployment.html">Adding HPCC</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCG_Deployment.html">Adding HPCG</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IMB_Deployment.html">Adding IMB</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IOR_Deployment.html">Adding IOR</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_MDTest_Deployment.html">Adding MDTest</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NWChem_Deployment.html">Adding NWChem</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_GAMESS_Deployment.html">Adding GAMESS</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_ENZO_Deployment.html">Adding ENZO</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Tasks_Scheduling.html">Scheduling Appkernels</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Walltimelimit_Setting.html">Setting AK Walltime</a></li>
                            
                    
                    </ul>
                
            
                <h2>Details</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_HowItWorks.html">How It Works</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Batch_Job_Script_Generation.html">Batch Job Script Generation</a></li>
                            
                    
                    </ul>
                
            
                <h2>Next</h2>
                
                    <ul>
                    
                            
                            <li ><a href="https://appkernels.xdmod.org/">xdmod-appkernels</a></li>
                            
                    
                    </ul>
                
            
        
    </div>
          
        
      </div>
      <div id="page-content">
         <h1></h1> 
        <p>Sample Output from Running Batch Job Script Generation for HPCG</p>

<p>Command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>akrr task new <span class="nt">--dry-run</span> <span class="nt">--gen-batch-job-only</span> <span class="nt">-n</span> 2 <span class="nt">-r</span> <span class="nv">$RESOURCE</span> <span class="nt">-a</span> hpcg
</code></pre></div></div>

<p>Output:</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DryRun: Should submit following to REST API (POST to scheduled_tasks) {'repeat_in': None, 'app': 'hpcg', 'resource_param': "{'nnodes':2}", 'time_to_start': None, 'resource': 'ub-hpc-skx'}
[INFO] Creating task directory: /home/akrruser/akrr/log/data/ub-hpc-skx/hpcg/2019.03.29.13.34.04.051502
[INFO] Creating task directories: 
        /home/akrruser/akrr/log/data/ub-hpc-skx/hpcg/2019.03.29.13.34.04.051502/jobfiles
        /home/akrruser/akrr/log/data/ub-hpc-skx/hpcg/2019.03.29.13.34.04.051502/proc
[INFO] auto_walltime_limit is on, trying to estimate walltime limit...
[INFO] There are only 0 previous run, need at least 5 for walltime limit autoset
[INFO] Below is content of generated batch job script:
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH --partition=skylake</span>
<span class="c">#SBATCH --qos=general-compute</span>
<span class="c">#SBATCH --nodes=2</span>
<span class="c">#SBATCH --ntasks-per-node=4</span>
<span class="c">#SBATCH --time=00:30:00</span>
<span class="c">#SBATCH --output=/projects/ccrstaff/general/nikolays/huey_slx/tmp/akrr_data/ub-hpc-skx/hpcg/2019.03.29.13.34.04.051502/stdout</span>
<span class="c">#SBATCH --error=/projects/ccrstaff/general/nikolays/huey_slx/tmp/akrr_data/ub-hpc-skx/hpcg/2019.03.29.13.34.04.051502/stderr</span>


<span class="c">#Common commands</span>
<span class="nb">export </span><span class="nv">AKRR_NODES</span><span class="o">=</span>2
<span class="nb">export </span><span class="nv">AKRR_CORES</span><span class="o">=</span>64
<span class="nb">export </span><span class="nv">AKRR_CORES_PER_NODE</span><span class="o">=</span>32
<span class="nb">export </span><span class="nv">AKRR_NETWORK_SCRATCH</span><span class="o">=</span><span class="s2">"/projects/ccrstaff/general/nikolays/huey_slx/tmp"</span>
<span class="nb">export </span><span class="nv">AKRR_LOCAL_SCRATCH</span><span class="o">=</span><span class="s2">"/tmp"</span>
<span class="nb">export </span><span class="nv">AKRR_TASK_WORKDIR</span><span class="o">=</span><span class="s2">"/projects/ccrstaff/general/nikolays/huey_slx/tmp/akrr_data/ub-hpc-skx/hpcg/2019.03.29.13.34.04.051502"</span>
<span class="nb">export </span><span class="nv">AKRR_APPKER_DIR</span><span class="o">=</span><span class="s2">"/projects/ccrstaff/general/nikolays/huey_slx/appker"</span>
<span class="nb">export </span><span class="nv">AKRR_AKRR_DIR</span><span class="o">=</span><span class="s2">"/projects/ccrstaff/general/nikolays/huey_slx/tmp/akrr_data/ub-hpc-skx"</span>

<span class="nb">export </span><span class="nv">AKRR_APPKER_NAME</span><span class="o">=</span><span class="s2">"hpcg"</span>
<span class="nb">export </span><span class="nv">AKRR_RESOURCE_NAME</span><span class="o">=</span><span class="s2">"ub-hpc-skx"</span>
<span class="nb">export </span><span class="nv">AKRR_TIMESTAMP</span><span class="o">=</span><span class="s2">"2019.03.29.13.34.04.051502"</span>
<span class="nb">export </span><span class="nv">AKRR_APP_STDOUT_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$AKRR_TASK_WORKDIR</span><span class="s2">/appstdout"</span>

<span class="nb">export </span><span class="nv">AKRR_APPKERNEL_INPUT</span><span class="o">=</span><span class="s2">"/projects/ccrstaff/general/nikolays/huey_slx/appker/inputs/hpcg/hpcg.dat"</span>
<span class="nb">export </span><span class="nv">AKRR_APPKERNEL_EXECUTABLE</span><span class="o">=</span><span class="s2">"/projects/ccrstaff/general/nikolays/huey_slx/appker/execs"</span>

<span class="nb">source</span> <span class="s2">"</span><span class="nv">$AKRR_APPKER_DIR</span><span class="s2">/execs/bin/akrr_util.bash"</span>

<span class="c">#Populate list of nodes per MPI process</span>
<span class="nb">export </span><span class="nv">AKRR_NODELIST</span><span class="o">=</span><span class="sb">`</span>srun <span class="nt">-l</span> <span class="nt">--ntasks-per-node</span><span class="o">=</span><span class="nv">$AKRR_CORES_PER_NODE</span> <span class="nt">-n</span> <span class="nv">$AKRR_CORES</span> <span class="nb">hostname</span> <span class="nt">-s</span>|sort <span class="nt">-n</span>| <span class="nb">awk</span> <span class="s1">'{printf "%s ",$2}'</span> <span class="sb">`</span>

<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$AKRR_APPKER_DIR</span><span class="s2">/execs/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>

<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$AKRR_TASK_WORKDIR</span><span class="s2">"</span>

<span class="c">#run common tests</span>
akrr_perform_common_tests

<span class="c">#Write some info to gen.info, JSON-Like file</span>
akrr_write_to_gen_info <span class="s2">"start_time"</span> <span class="s2">"</span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="s2">"</span>
akrr_write_to_gen_info <span class="s2">"node_list"</span> <span class="s2">"</span><span class="nv">$AKRR_NODELIST</span><span class="s2">"</span>


<span class="c"># Create working dir</span>
<span class="nb">export </span><span class="nv">AKRR_TMP_WORKDIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">mktemp</span> <span class="nt">-d</span> /projects/ccrstaff/general/nikolays/huey_slx/tmp/ak.XXXXXXXXX<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"Temporary working directory: </span><span class="nv">$AKRR_TMP_WORKDIR</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="nv">$AKRR_TMP_WORKDIR</span>

<span class="c"># Copy inputs</span>
<span class="nb">cp</span> /projects/ccrstaff/general/nikolays/huey_slx/appker/inputs/hpcg/hpcg.dat ./hpcg.dat

<span class="nb">ulimit</span> <span class="nt">-s</span> unlimited



<span class="c"># Load application environment</span>
module load intel/18.3
module load intel-mpi/2018.3
module load mkl/2018.3
module list

<span class="c"># set executable location</span>
<span class="nv">EXE</span><span class="o">=</span><span class="nv">$MKLROOT</span>/benchmarks/hpcg/bin/xhpcg_skx
<span class="c"># EXE=$AKRR_APPKER_DIR/execs/hpcg-HPCG-release-3-0-0/build/bin/xhpcg</span>

<span class="c"># Set how to run app kernel</span>
<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span>1
<span class="nv">RUN_APPKERNEL</span><span class="o">=</span><span class="s2">"mpirun </span><span class="nv">$EXE</span><span class="s2">"</span>


<span class="c">#Generate AppKer signature</span>
appsigcheck.sh <span class="nv">$EXE</span> <span class="nv">$AKRR_TASK_WORKDIR</span>/.. <span class="o">&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span>


<span class="c">#Execute AppKer</span>
akrr_write_to_gen_info <span class="s2">"appkernel_start_time"</span> <span class="s2">"</span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="s2">"</span>
<span class="nv">$RUN_APPKERNEL</span> <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
akrr_write_to_gen_info <span class="s2">"appkernel_end_time"</span> <span class="s2">"</span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="s2">"</span>




akrr_write_to_gen_info <span class="s2">"cpu_speed"</span> <span class="s2">"</span><span class="sb">`</span><span class="nb">grep</span> <span class="s1">'cpu MHz'</span> /proc/cpuinfo<span class="sb">`</span><span class="s2">"</span>

<span class="c"># cat results to AKRR_APP_STDOUT_FILE</span>
<span class="k">for </span>f <span class="k">in</span> <span class="k">*</span>.yaml
<span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"====== </span><span class="nv">$f</span><span class="s2"> Start ======"</span>  <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
    <span class="nb">cat</span> <span class="nv">$f</span>  <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
    <span class="nb">echo</span> <span class="s2">"====== </span><span class="nv">$f</span><span class="s2"> End   ======"</span> <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
<span class="k">done
for </span>f <span class="k">in</span> <span class="k">*</span>.txt
<span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"====== </span><span class="nv">$f</span><span class="s2"> Start ======"</span>  <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
    <span class="nb">cat</span> <span class="nv">$f</span>  <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
    <span class="nb">echo</span> <span class="s2">"====== </span><span class="nv">$f</span><span class="s2"> End   ======"</span> <span class="o">&gt;&gt;</span> <span class="nv">$AKRR_APP_STDOUT_FILE</span> 2&gt;&amp;1
<span class="k">done

</span><span class="nb">cd</span> <span class="nv">$AKRR_TASK_WORKDIR</span>

<span class="c"># Clean-up</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">AKRR_DEBUG</span><span class="p">=no</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"no"</span> <span class="o">]</span>
<span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Deleting temporary files"</span>
        <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$AKRR_TMP_WORKDIR</span>
<span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Copying temporary files"</span>
        <span class="nb">cp</span> <span class="nt">-r</span> <span class="nv">$AKRR_TMP_WORKDIR</span> workdir
        <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$AKRR_TMP_WORKDIR</span>
<span class="k">fi



</span>akrr_write_to_gen_info <span class="s2">"end_time"</span> <span class="s2">"</span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="s2">"</span>
</code></pre></div></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Removing generated files from file-system as only batch job script printing was requested
</code></pre></div></div>

      </div>
      <div class="clear"></div>
    </div>
    <div id="page-footer">
      <a href="https://www.buffalo.edu/ccr" target="_blank"><img src="/xdmod-jekyll-theme/assets/images/ccr_logo.png" alt="Center for Computational Research"/></a>
    </div>
  </div>
</body>
</html>
