<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="utf-8">
  <title>Application Kernel Remote Runner (AKRR) </title>
  <link rel="icon" type="image/x-icon" href="/xdmod-jekyll-theme/assets/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/xdmod-jekyll-theme/assets/css/effervescence.css" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-44300156-3');
    ga('send', 'pageview');
  </script>
</head>
<body>
  <div id="page-container">
    <div id="page-header">
      <a href="http://open.xdmod.org"><img src="/xdmod-jekyll-theme/assets/images/xdmod_logo.png" alt="XDMoD" /></a>
      <span class="maintitle">Application Kernel Remote Runner (AKRR) Module 2.1.1</span>
    </div>
    
    <div id="page-body">
      <div class="clear"></div>
      <div id="page-menu">
          <div class="page-menu-toc">
        
            
                <h2>About</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/">Overview</a></li>
                            
                    
                    </ul>
                
            
                <h2>Download</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Download.html">Download</a></li>
                            
                    
                    </ul>
                
            
                <h2>Install</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Install.html">Install</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Update.html">Update</a></li>
                            
                    
                    </ul>
                
            
                <h2>Using</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Usage.html">Using</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Add_Resource.html">Adding New Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Deployment_of_Application_Kernel_on_Resource.html">Adding Appkernel to Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NAMD_Deployment.html">Adding NAMD</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCC_Deployment.html">Adding HPCC</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCG_Deployment.html">Adding HPCG</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IMB_Deployment.html">Adding IMB</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IOR_Deployment.html">Adding IOR</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_MDTest_Deployment.html">Adding MDTest</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NWChem_Deployment.html">Adding NWChem</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_GAMESS_Deployment.html">Adding GAMESS</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_ENZO_Deployment.html">Adding ENZO</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Tasks_Scheduling.html">Scheduling Appkernels</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Walltimelimit_Setting.html">Setting AK Walltime</a></li>
                            
                    
                    </ul>
                
            
                <h2>Details</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_HowItWorks.html">How It Works</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Batch_Job_Script_Generation.html">Batch Job Script Generation</a></li>
                            
                    
                    </ul>
                
            
                <h2>Next</h2>
                
                    <ul>
                    
                            
                            <li ><a href="https://appkernels.xdmod.org/">xdmod-appkernels</a></li>
                            
                    
                    </ul>
                
            
        
    </div>
          
        
      </div>
      <div id="page-content">
         <h1></h1> 
        <h2 id="deployment-of-hpcc-benchmark-for-openstack">Deployment of HPCC benchmark for Openstack</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">RESOURCE</span><span class="o">=</span>lakeeffect
<span class="nb">export </span><span class="nv">APPKER</span><span class="o">=</span>hpcc

<span class="c"># adding the resource to akrr</span>
akrr app add <span class="nt">-a</span> <span class="nv">$APPKER</span> <span class="nt">-r</span> <span class="nv">$RESOURCE</span>

</code></pre></div></div>
<p>Sample output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>INFO] Generating application kernel configuration <span class="k">for </span>hpcc on lakeeffect
<span class="o">[</span>INFO] Application kernel configuration <span class="k">for </span>hpcc on lakeeffect is <span class="k">in</span>: 
        /home/hoffmaps/projects/akrr/etc/resources/lakeeffect/hpcc.app.conf
</code></pre></div></div>
<p>So on openStack we don’t have to worry about loading up modules and such, we just want to run the dockerfile
So take a look at hpcc.app.conf</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>appkernel_run_env_template <span class="o">=</span> <span class="s2">"""
# Load application environment
module load intel
module load intel-mpi
module load mkl
module list

# make srun works with intel mpi
export I_MPI_PMI_LIBRARY=/usr/lib64/libpmi.so

# set how to run app kernel
RUN_APPKERNEL="</span>srun <span class="o">{</span>appkernel_dir<span class="o">}</span>/<span class="o">{</span>executable<span class="o">}</span><span class="s2">"
"""</span>

</code></pre></div></div>
<p>We really only care about the RUN_APPKERNEL, so everything else can be commented out or removed</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">RUN_APPKERNEL</span><span class="o">=</span><span class="s2">"docker run pshoff/akrr_benchmarks:hpcc"</span>
</code></pre></div></div>

<p>Perform validation run - only 1 node</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>akrr app validate <span class="nt">-n</span> 1 <span class="nt">-r</span> <span class="nv">$RESOURCE</span> <span class="nt">-a</span> <span class="nv">$APPKER</span> 
</code></pre></div></div>
<p>So this gave a whole bunch of errors, then gave me errors when handling those errors
I think it could have to do with the whole remote access node? so I gave it a name in the resource.conf for lakeeffect instead of just None, then I re-deployed resource</p>
<ul>
  <li>Yeah that didn’t work
Nikolay suggested a workaround for now, namely to spin up an instance before the ssh happens, then delete it after
    <ul>
      <li>(see resource_deploy for how to spin up a resource first, about at line 744)</li>
      <li>The error when doing the validation happens at about line 123 in app_validate.py, so putting the instance spin up thing in right before that</li>
    </ul>
  </li>
</ul>

<p>The following code blocks were added:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># (Around line 124 of akrr.app_validate.py)
#### ADDED BY PHILLIP HOFFMANN TO SPIN UP INSTANCE BEFORE SSH        
</span><span class="k">if</span> <span class="n">resource</span><span class="p">[</span><span class="s">'batch_scheduler'</span><span class="p">].</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">"openstack"</span><span class="p">:</span>
	<span class="c1"># Start instance if it is cloud
</span>        <span class="n">openstack_server</span> <span class="o">=</span> <span class="n">akrr</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">openstack</span><span class="p">.</span><span class="n">OpenStackServer</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">)</span>
        <span class="n">resource</span><span class="p">[</span><span class="s">'openstack_server'</span><span class="p">]</span> <span class="o">=</span> <span class="n">openstack_server</span>
        <span class="n">openstack_server</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">resource</span><span class="p">[</span><span class="s">'remote_access_node'</span><span class="p">]</span> <span class="o">=</span> <span class="n">openstack_server</span><span class="p">.</span><span class="n">ip</span>
<span class="c1">#### ADDED BY PHILLIP HOFFMANN
</span>
<span class="c1"># (Around line 184 of akrr.app_validate.py
#### ADDED BY PHILLIP HOFFMANN TO DELETE OPENSTACK INSTANCE AFTER TESTS
</span><span class="k">if</span> <span class="n">resource</span><span class="p">[</span><span class="s">'batch_scheduler'</span><span class="p">].</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">"openstack"</span><span class="p">:</span>
        <span class="c1"># delete instance if it is cloud
</span>        <span class="n">resource</span><span class="p">[</span><span class="s">'openstack_server'</span><span class="p">].</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">resource</span><span class="p">[</span><span class="s">'remote_access_node'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c1">#### ADDED BY PHILLIP HOFFMANN
</span>


</code></pre></div></div>
<p>Okay that appears to allow us to connect to the resource
Now we are getting errors in terms of connecting to the docker daemon.
For now I’m gonna put this in the config, but might consider putting it in resource.conf file header?</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># put at start of hpcc.app.conf</span>
<span class="nb">sudo </span>systemctl start docker
<span class="sb">```</span>bash

- Update: okay docker is started now, but the docker hub repo was private so I made it public to see <span class="k">if </span>at least the docker thing works

- Update: it completed successfully, seems we have everything we need, I<span class="s1">'ll check it all over again tomorrow, but it appears hpcc works
- Yeah everything appears to be working as normal, no weird things other than a logging error, but I don'</span>t think that really affects anything

- UPDATE: Editing the place that calls the docker run to remove container on <span class="nb">exit</span>, so the hpcc.app.conf is now this:
<span class="sb">```</span>bash
appkernel_run_env_template <span class="o">=</span> <span class="s2">"""
sudo systemctl start docker
docker pull pshoff/akrr_benchmarks:hpcc
# set how to run app kernel
RUN_APPKERNEL="</span>docker run <span class="nt">--rm</span> pshoff/akrr_benchmarks:hpcc<span class="s2">"
"""</span>
</code></pre></div></div>
<p>Also don’t forget the pull to get the most updated version of the docker file</p>

<p>Example of validation run is in openStack_hpcc_validation_example</p>


      </div>
      <div class="clear"></div>
    </div>
    <div id="page-footer">
      <a href="https://www.buffalo.edu/ccr" target="_blank"><img src="/xdmod-jekyll-theme/assets/images/ccr_logo.png" alt="Center for Computational Research"/></a>
    </div>
  </div>
</body>
</html>
