<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="utf-8">
  <title>Application Kernel Remote Runner (AKRR) </title>
  <link rel="icon" type="image/x-icon" href="/xdmod-jekyll-theme/assets/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/xdmod-jekyll-theme/assets/css/effervescence.css" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-44300156-3');
    ga('send', 'pageview');
  </script>
</head>
<body>
  <div id="page-container">
    <div id="page-header">
      <a href="http://open.xdmod.org"><img src="/xdmod-jekyll-theme/assets/images/xdmod_logo.png" alt="XDMoD" /></a>
      <span class="maintitle">Application Kernel Remote Runner (AKRR) Module 2.1.1</span>
    </div>
    
    <div id="page-body">
      <div class="clear"></div>
      <div id="page-menu">
          <div class="page-menu-toc">
        
            
                <h2>About</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/">Overview</a></li>
                            
                    
                    </ul>
                
            
                <h2>Download</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Download.html">Download</a></li>
                            
                    
                    </ul>
                
            
                <h2>Install</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Install.html">Install</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Update.html">Update</a></li>
                            
                    
                    </ul>
                
            
                <h2>Using</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_Usage.html">Using</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Add_Resource.html">Adding New Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Deployment_of_Application_Kernel_on_Resource.html">Adding Appkernel to Resource</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NAMD_Deployment.html">Adding NAMD</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCC_Deployment.html">Adding HPCC</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_HPCG_Deployment.html">Adding HPCG</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IMB_Deployment.html">Adding IMB</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_IOR_Deployment.html">Adding IOR</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_MDTest_Deployment.html">Adding MDTest</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_NWChem_Deployment.html">Adding NWChem</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_GAMESS_Deployment.html">Adding GAMESS</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_ENZO_Deployment.html">Adding ENZO</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Tasks_Scheduling.html">Scheduling Appkernels</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Walltimelimit_Setting.html">Setting AK Walltime</a></li>
                            
                    
                    </ul>
                
            
                <h2>Details</h2>
                
                    <ul>
                    
                            
                            <li ><a href="/AKRR_HowItWorks.html">How It Works</a></li>
                            
                    
                            
                            <li ><a href="/AKRR_Batch_Job_Script_Generation.html">Batch Job Script Generation</a></li>
                            
                    
                    </ul>
                
            
                <h2>Next</h2>
                
                    <ul>
                    
                            
                            <li ><a href="https://appkernels.xdmod.org/">xdmod-appkernels</a></li>
                            
                    
                    </ul>
                
            
        
    </div>
          
        
      </div>
      <div id="page-content">
         <h1></h1> 
        <h2 id="notes-on-getting-hpcc-working-on-huey-with-singularity">Notes on getting hpcc working on huey with singularity</h2>

<p>The site where it describes how to use a docker image with singularity is here: https://www.sylabs.io/guides/3.2/user-guide/singularity_and_docker.html</p>

<p>It does talk about a cache directory that singularity uses, and I decided to make my own so that the default home directory isn’t used. I put it here:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span>/gpfs/scratch/hoffmaps/singularity_cache
</code></pre></div></div>
<p>So that declaration should probably come before any sort of singularity work</p>

<p>Okay, so now lets look into deployment. It’ll be a mix between Openstack and regular deployment</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">RESOURCE</span><span class="o">=</span>test_huey
<span class="nb">export </span><span class="nv">APPKER</span><span class="o">=</span>hpcc

<span class="c"># adding the resource to akrr</span>
akrr app add <span class="nt">-a</span> <span class="nv">$APPKER</span> <span class="nt">-r</span> <span class="nv">$RESOURCE</span>
</code></pre></div></div>
<p>Output:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>INFO] Generating application kernel configuration <span class="k">for </span>hpcc on test_huey
<span class="o">[</span>INFO] Application kernel configuration <span class="k">for </span>hpcc on test_huey is <span class="k">in</span>: 
        /home/hoffmaps/projects/akrr/etc/resources/test_huey/hpcc.app.conf

</code></pre></div></div>
<p>Initial hpcc.app.conf</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
appkernel_run_env_template <span class="o">=</span> <span class="s2">"""
# Load application environment
module load intel
module load intel-mpi
module load mkl
module list

# make srun works with intel mpi
export I_MPI_PMI_LIBRARY=/usr/lib64/libpmi.so

# set how to run app kernel
RUN_APPKERNEL="</span>srun <span class="o">{</span>appkernel_dir<span class="o">}</span>/<span class="o">{</span>executable<span class="o">}</span><span class="s2">"
"""</span>

</code></pre></div></div>

<p>Like before, we mainly just care about the RUN_APPKERNEL since its all self contained
So lets change it so that it get the singularity container and runs it (don’t forget to set the SINGULARITY_CACHEDIR</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span>/gpfs/scratch/hoffmaps/singularity_cache

<span class="nv">RUN_APPKERNEL</span><span class="o">=</span>&lt;TBD&gt; <span class="o">(</span>see below<span class="o">)</span>
</code></pre></div></div>
<p>Update: messing around a bit with singularity containers on huey, looks like if I get the container on the node its fine, but not if its just on the regular thing</p>

<p>So trying to run the singularity containers, was getting an error that said that singularity doesn’t know about the whole workdir thing of docker, so we should use absolute paths in the dockerfile thing. The issue was discussed here: https://github.com/sylabs/singularity/issues/380
So Imma change the dockerfile real quick so that the entrypoint script is an absolute path.</p>

<p>Recommendation: have all the docker images and whatnot already pulled down so that you don’t need to waste time getting them set up.</p>

<p>+++++++ CHECK THIS
So, I also need to change the run script for things, since the number of cores doesn’t really help/isn’t an accurate representation of the number of processes we need. FOR NOW, I think we’ll rely on the flags for the run, setting -ppn to the appropriate number locally
*This may need to be changed in the future, unsure of the correct path to take
+++++++</p>

<p>So now our hpcc.app.conf looks like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>appkernel_run_env_template <span class="o">=</span> <span class="s2">"""
export SINGULARITY_CACHEDIR="</span>/gpfs/scratch/hoffmaps/singularity_cache<span class="s2">"

# set how to run app kernel (the ppn 8 is temporary just to get it to work, to be changed in future)
RUN_APPKERNEL="</span>singularity run <span class="nv">$SINGULARITY_CACHEDIR</span>/akrr_benchmarks_hpcc.sif <span class="nt">-ppn</span> 8<span class="s2">"
"""</span>
</code></pre></div></div>
<p>Again, this is assuming we did the following on huey (or similar)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span>/gpfs/scratch/hoffmaps/singularity_cache
<span class="nb">cd</span> <span class="nv">$SINGULARITY_CACHEDIR</span>
singularity pull <span class="nt">--docker-login</span> docker://pshoff/akrr_benchmarks:hpcc 

</code></pre></div></div>
<p>And entered the proper password and such to get the sif file</p>

<p>Now let’s try validation run</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>akrr app validate <span class="nt">-n</span> 1 <span class="nt">-r</span> test_huey <span class="nt">-a</span> hpcc


</code></pre></div></div>
<p>Okay this right now gives a bunch of errors. If I set it up normally on huey and just do the regular run there, it seems to go fine, but when I try and do the validation run, it doesn’t work. Here’s what the weird output is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> ERROR: /gpfs/scratch/hoffmaps/akrr_project/execs/hpcc/hpcc is not an executable binary file
hpcc_inputs_dir: /usr/local/appker/inputs/hpcc
Number of cores detected: 4
nodes: 1
ppn: 8
interactive: <span class="nb">false
</span>Testing entry: 1
Entry is valid
Testing entry: 8
Entry is valid
Input file name: hpccinf.txt.8x1
Full path: /usr/local/appker/inputs/hpcc/hpccinf.txt.8x1
Destination path: /user/hoffmaps/hpccinf.txt
hpccinf.txt.8x1 copied over to /user/hoffmaps/hpccinf.txt
work <span class="nb">dir</span>: /user/hoffmaps
Running appsigcheck...
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/opt/appker/execs/hpcc-1.5.0/hpcc'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/lib64/libpthread.so.0'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/lib64/libm.so.6'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: not is not an executable binary file
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: not is not an executable binary file
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/lib64/libdl.so.2'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/lib64/librt.so.1'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/lib64/libgcc_s.so.1'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
<span class="nb">mktemp</span>: failed to create file via template ‘/scratch/12434/tmp.XXXXXXXXXX’: No such file or directory
objcopy: warning: could not create temporary file whilst copying <span class="s1">'/lib64/libc.so.6'</span>, <span class="o">(</span>error: Read-only file system<span class="o">)</span>
<span class="o">===</span><span class="nv">ExeBinSignature</span><span class="o">===</span> MD5: Unable to run objcopy
Running hpcc...
<span class="o">[</span>mpiexec@cpn-d13-17.int.ccr.buffalo.edu] HYDU_create_process <span class="o">(</span>../../utils/launch/launch.c:825<span class="o">)</span>: execvp error on file /usr/bin/srun <span class="o">(</span>No such file or directory<span class="o">)</span>
</code></pre></div></div>
<p>A couple weird things about this
	- MD5 can’t run objcopy
	- There’s something weird going on with the creation of a scratch directory, perhaps that’s something to look at with the general template
	- Something strange is happening with mpiexec, though that should be happening in the singularity…??
	- It seems like there’s something wrong with the environment variables, since its trying to copy things into /home/hoffmaps instead of /home/hpccuser like it does in Docker.
I’ll look into these tomorrow</p>

<ul>
  <li>
    <p>So, it appears maybe things went wrong bc in singularity everything is root? so now just trying to run docker as if everythig is root..</p>
  </li>
  <li>
    <p>Okay so I found here: https://singularity.lbl.gov/docs-docker#troubleshooting that we shouldn’t be doing anything with $HOME because that gets mounted as my home and not the home that I want (aka hpccuser home) so imma change that in the dockerfile so now instead of $HOME it’ll be /home/hpccuser</p>
  </li>
  <li>So things are sorta weird with how singularity deals with users….</li>
  <li>
    <p>It runs the singularity as whatever user it is, but we want to run as hpccuser in the container, so I’m trying to change things up so that I run as hpccuser</p>
  </li>
  <li>
    <p>Update: so we want to set up the docker so that its able to run as any user so that we don’t have to worry about switching users or anything like that</p>
  </li>
  <li>
    <p>Updated permissions so now more or less everything we would use has overarching permissions</p>
  </li>
  <li>The objcopy issue happens when trying to run appsigcheck</li>
  <li>The mpiexec error happens when actually trying to execute hpcc</li>
</ul>

<p>Also changed app conf to be this now, the cache directory thing isn’t really that important</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>appkernel_run_env_template <span class="o">=</span> <span class="s2">"""
export SINGULARITY_IMAGEDIR="</span>/gpfs/scratch/hoffmaps/singularity_images<span class="s2">"

# set how to run app kernel ( the ppn 8 is temporary, perhaps to change to be general)
RUN_APPKERNEL="</span><span class="nv">$SINGULARITY_IMAGEDIR</span>/akrr_benchmarks_hpcc.sif <span class="nt">-ppn</span> 8<span class="s2">"
"""</span>
</code></pre></div></div>

<h3 id="trying-to-fix-the-objcopy-issue">Trying to fix the objcopy issue:</h3>
<ul>
  <li>First I’m trying to change the permissions on the files to be 777 so everything should be readable and writable
    <ul>
      <li>Yeah that wasn’t the issue. Turns out with singularity, everything enters in read only mode by default (see: http://singularity.lbl.gov/archive/docs/v2-2/create-image#read-only-vs-read-write) so now I’m setting the writable flag</li>
      <li>That also didn’t work….. unsure what’s going on</li>
      <li>The weirdest thing is that it seems to work fine if I’m just running the image in the terminal</li>
    </ul>
  </li>
  <li>
    <p>UPDATE: So Ben helped me a whole bunch. There was the error with the md5sum2 that just gave a bunch of weird stuff, saying it couldn’t make the temp directory and stuff like that. The singularity thing ran fine when I sshed into the node and ran it, but it didn’t work when I did sbatch. Turns out the problem happens with sbatch bc it sets the environment TMPDIR to be /scratch/[jobid] whereas with the salloc stuff TMPDIR wasn’t set. So at the beginning of the job I just did unset TMPDIR and the md5sum2 thing worked fine/as expected</p>
  </li>
  <li>UPDATE: so there was the problem with mpirun trying to run srun, which of course doesn’t exist in the singularity container. It was doing that because one of the environment variables that was set with the sbatch was a SLURM environment variable, so it thought the scheduler was slurm, so it tried to run srun. The fix: set I_MPI_HYDRA_BOOTSTRAP to be ssh (the default) before running the container.
    <ul>
      <li>Update: this may not be the SAFEST option. But it works so far</li>
    </ul>
  </li>
</ul>

<p>SO, I changed up the script so now it deletes the old hpccout, so there’s no confusion.
I added some waits to allow the things to run all the way through and display
Also I changed the working directory to /tmp so that it wasn’t in the home one all the time.</p>

<p>Remember also to pull the singularity image you want to use down from docker and putting into $SINGULARITY_IMAGEDIR
Now, the hpcc.app.conf should look something like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>appkernel_run_env_template <span class="o">=</span> <span class="s2">"""

export SINGULARITY_IMAGEDIR="</span>/gpfs/scratch/hoffmaps/singularity_images<span class="s2">"
export I_MPI_HYDRA_BOOTSTRAP="</span>ssh<span class="s2">"
unset TMPDIR

# set how to run app kernel ( the ppn 8 is temporary, perhaps to change to be general)
RUN_APPKERNEL="</span><span class="nv">$SINGULARITY_IMAGEDIR</span>/akrr_benchmarks_hpcc.sif <span class="nt">-ppn</span> 8<span class="s2">"
"""</span>
</code></pre></div></div>
<p>That works! At least things went well with it. Only sorta weird thing it looks like is RunEnv:Nodes, which is some weird sha256(?) value? But other than that seems to be fine.</p>

<p>UPDATE: Changed it so that the temporary place where files are housed is in $PWD. If running docker regularly, it will be in /scratch. If run in singularity, it will be run in $PWD</p>

<p>Then do periodic things</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>akrr task new <span class="nt">-r</span> test_huey <span class="nt">-a</span> namd <span class="nt">-n</span> 1 <span class="nt">-t0</span> <span class="s2">"01:00"</span> <span class="nt">-t1</span> <span class="s2">"05:00"</span> <span class="nt">-p</span> 1

</code></pre></div></div>


      </div>
      <div class="clear"></div>
    </div>
    <div id="page-footer">
      <a href="https://www.buffalo.edu/ccr" target="_blank"><img src="/xdmod-jekyll-theme/assets/images/ccr_logo.png" alt="Center for Computational Research"/></a>
    </div>
  </div>
</body>
</html>
